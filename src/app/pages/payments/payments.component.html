<app-header title="Payments Management"></app-header>

<div class="content">
  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading">Loading...</div>

  <!-- Header with Add Button -->
  <div class="page-header">
    <button class="btn btn-primary" (click)="openAddModal()">
      Record Payment
    </button>
  </div>

  <!-- Search and Filter Bar -->
  <div class="search-bar">
    <input
      type="text"
      class="search-input"
      placeholder="Search by reference or invoice..."
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilters()"
    />

    <select
      class="form-select"
      [(ngModel)]="methodFilter"
      (ngModelChange)="applyFilters()"
      style="width: auto"
    >
      <option value="">All Methods</option>
      <option value="Cash">Cash</option>
      <option value="Bank Transfer">Bank Transfer</option>
      <option value="Credit Card">Credit Card</option>
      <option value="Debit Card">Debit Card</option>
      <option value="Cheque">Cheque</option>
      <option value="UPI">UPI</option>
      <option value="Other">Other</option>
    </select>

    <button class="btn btn-secondary" (click)="sortByDate()">
      Sort by Date
    </button>
  </div>

  <!-- Payments Table -->
  <table class="table">
    <thead>
      <tr>
        <th>Invoice Number</th>
        <th>Amount</th>
        <th>Payment Date</th>
        <th>Method</th>
        <th>Reference</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngIf="filteredPayments.length === 0">
        <td colspan="6" style="text-align: center; color: #64748b">
          No payments found
        </td>
      </tr>
      <tr *ngFor="let payment of filteredPayments">
        <td>
          {{
            payment.invoice?.invoiceNumber ||
              getInvoiceNumber(payment.invoiceId)
          }}
        </td>
        <td>{{ payment.amount | currency }}</td>
        <td>{{ payment.paymentDate | date }}</td>
        <td>
          <span
            class="method-badge"
            [ngClass]="
              'method-' +
              (payment.method || 'other').toLowerCase().replace(' ', '-')
            "
          >
            {{ payment.method || "N/A" }}
          </span>
        </td>
        <td>{{ payment.reference || "N/A" }}</td>
        <td>
          <button
            class="btn btn-secondary btn-sm"
            (click)="viewPaymentDetails(payment.id || '')"
          >
            View
          </button>
          <button
            class="btn btn-secondary btn-sm"
            (click)="openEditModal(payment)"
          >
            Edit
          </button>
          <button
            class="btn btn-danger btn-sm"
            (click)="deletePayment(payment.id || '')"
          >
            Delete
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Add/Edit Modal -->
<div class="modal" [class.active]="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        {{ isEditing ? "Edit Payment" : "Record New Payment" }}
      </h2>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>

    <form (ngSubmit)="savePayment()">
      <div class="form-group">
        <label class="form-label" for="invoice-id">Invoice *</label>
        <select
          class="form-select"
          id="invoice-id"
          [(ngModel)]="currentPayment.invoiceId"
          name="invoiceId"
          required
        >
          <option value="">Select Invoice</option>
          <option *ngFor="let invoice of invoices" [value]="invoice.id">
            {{ invoice.invoiceNumber }} - {{ invoice.totalAmount | currency }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="amount">Amount *</label>
        <input
          type="number"
          class="form-input"
          id="amount"
          [(ngModel)]="currentPayment.amount"
          name="amount"
          step="0.01"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-date">Payment Date *</label>
        <input
          type="date"
          class="form-input"
          id="payment-date"
          [(ngModel)]="currentPayment.paymentDate"
          name="paymentDate"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="method">Payment Method</label>
        <select
          class="form-select"
          id="method"
          [(ngModel)]="currentPayment.method"
          name="method"
        >
          <option value="Cash">Cash</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Credit Card">Credit Card</option>
          <option value="Debit Card">Debit Card</option>
          <option value="Cheque">Cheque</option>
          <option value="UPI">UPI</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="reference">Reference Number</label>
        <input
          type="text"
          class="form-input"
          id="reference"
          [(ngModel)]="currentPayment.reference"
          name="reference"
          placeholder="Transaction ID, Cheque Number, etc."
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
          {{ isEditing ? "Update Payment" : "Record Payment" }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Details Modal -->
<div
  class="modal"
  [class.active]="showDetailsModal"
  (click)="closeDetailsModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Payment Details</h2>
      <button class="close-btn" (click)="closeDetailsModal()">×</button>
    </div>

    <div *ngIf="selectedPayment" class="details-content">
      <div class="detail-row">
        <span class="detail-label">Payment ID:</span>
        <span class="detail-value">{{ selectedPayment.id }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Invoice Number:</span>
        <span class="detail-value">{{
          selectedPayment.invoice?.invoiceNumber || "N/A"
        }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Amount:</span>
        <span class="detail-value">{{
          selectedPayment.amount | currency
        }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Payment Date:</span>
        <span class="detail-value">{{
          selectedPayment.paymentDate | date : "medium"
        }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Payment Method:</span>
        <span class="detail-value">
          <span
            class="method-badge"
            [ngClass]="
              'method-' +
              (selectedPayment.method || 'other')
                .toLowerCase()
                .replace(' ', '-')
            "
          >
            {{ selectedPayment.method || "N/A" }}
          </span>
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Reference Number:</span>
        <span class="detail-value">{{
          selectedPayment.reference || "N/A"
        }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Created At:</span>
        <span class="detail-value">{{
          selectedPayment.createdAt | date : "medium"
        }}</span>
      </div>
    </div>

    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeDetailsModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>
